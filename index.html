
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ODST LIFE RPG</title>
  <meta name="theme-color" content="#0a1012" />
  <style>
    :root{
      --bg:#070b0d; --panel:#0b1215; --hud:#35f0d0; --hud2:#33b3ff;
      --text:#d6f7f0; --muted:#7ab9ad; --danger:#ff5e7a; --warn:#ffd36e;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 700px at 15% 10%, rgba(51,179,255,.08), transparent 60%),
        radial-gradient(800px 700px at 85% 20%, rgba(53,240,208,.06), transparent 55%),
        radial-gradient(800px 700px at 60% 90%, rgba(53,240,208,.04), transparent 60%),
        linear-gradient(180deg,#05090b,var(--bg));
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(10px);
      background:linear-gradient(180deg, rgba(5,9,11,.88), rgba(5,9,11,.35));
      border-bottom:1px solid rgba(53,240,208,.12);
    }
    .topbar-inner{max-width:560px;margin:0 auto;padding:14px;display:flex;justify-content:space-between;gap:12px;align-items:flex-end}
    h1{margin:0;font-size:16px;letter-spacing:.16em;text-transform:uppercase;color:var(--hud)}
    small{color:var(--muted)}
    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(53,240,208,.22);background:rgba(53,240,208,.06);
      font-size:12px;letter-spacing:.06em;text-transform:uppercase;
      white-space:nowrap;
    }
    .hud-line{height:1px;background:linear-gradient(90deg,transparent,rgba(53,240,208,.55),transparent)}
    .container{max-width:560px;margin:0 auto;padding:14px 14px 110px}
    .card{
      background:linear-gradient(180deg, rgba(11,18,21,.92), rgba(8,16,20,.85));
      border:1px solid rgba(53,240,208,.14);
      box-shadow:var(--shadow);
      border-radius:28px;
      padding:14px;
    }
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    .between{justify-content:space-between}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .btn{
      border:1px solid rgba(53,240,208,.25); background:rgba(53,240,208,.07); color:var(--text);
      border-radius:14px; padding:10px 12px; font-weight:800; cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(51,179,255,.35);background:rgba(51,179,255,.10)}
    .btn.danger{border-color:rgba(255,94,122,.35);background:rgba(255,94,122,.10)}
    .btn.ghost{border-color:rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .btn.small{padding:8px 10px;font-size:13px}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(53,240,208,.18); background:rgba(0,0,0,.22); color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    label{display:block;font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin:10px 0 6px}
    .hr{height:1px;background:rgba(53,240,208,.12);margin:12px 0}
    .progress{height:12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(53,240,208,.12);overflow:hidden}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg, rgba(53,240,208,.95), rgba(51,179,255,.75))}
    .kpi .value{font-size:22px;font-weight:900}
    .kpi .label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      padding:12px 12px 18px;
      background:linear-gradient(180deg, rgba(5,9,11,0), rgba(5,9,11,.92) 25%, rgba(5,9,11,.98));
      border-top:1px solid rgba(53,240,208,.12);
      backdrop-filter:blur(10px);
    }
    .tabbar-inner{max-width:560px;margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .tab{
      border-radius:16px;padding:10px 8px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
      text-align:center;font-size:11px;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;user-select:none;
    }
    .tab.active{border-color:rgba(53,240,208,.30);background:rgba(53,240,208,.09)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(53,240,208,.18);background:rgba(53,240,208,.05);
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.35}
    .box{
      padding:12px;border-radius:18px;border:1px solid rgba(53,240,208,.14);background:rgba(255,255,255,.03)
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <h1>ODST LIFE RPG</h1>
        <small>HUD · Offline · 1 fichier</small>
      </div>
      <div class="pill" id="topPill">STATION HUD</div>
    </div>
    <div class="hud-line"></div>
  </div>

  <div class="container" id="app"></div>

  <div class="tabbar">
    <div class="tabbar-inner" id="tabs"></div>
  </div>

<script>
const KEY = "odstLifeRpg.single.v1";
const $ = sel => document.querySelector(sel);

function todayKey(d=new Date()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function msToClock(ms){
  const s=Math.max(0, Math.floor(ms/1000));
  const mm=String(Math.floor(s/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
function load(){
  try{ const raw=localStorage.getItem(KEY); return raw? JSON.parse(raw): null; }catch{ return null; }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(), gain=ctx.createGain();
    osc.frequency.value=880; gain.gain.value=0.05;
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); setTimeout(()=>{osc.stop();ctx.close()},120);
  }catch{}
}
function vibrate(ms=200){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{} }

const DEFAULTS = {
  meta:{ streak:0, lastXpDay:null },
  xp:{ total:0, byDay:{} },
  finance:{
    bars:[
      { id:'safety', name:'Épargne sécurité', current:1500, target:2000 },
      { id:'mother', name:'Dette maman (restant)', current:1500, target:0 },
      { id:'sisters', name:'Dette sœurs (restant)', current:16000, target:0 },
      { id:'car', name:'Voiture', current:0, target:6000 },
    ]
  },
  quests:{
    items:[
      {id:'sport', cat:'Sport', name:'Séance (A/B/MINI)', xp:250},
      {id:'walk', cat:'Sport', name:'10 min marche', xp:60},
      {id:'quiz', cat:'Langues', name:'Micro-quiz', xp:80},
      {id:'write', cat:'Langues', name:'Phrase écrite', xp:80},
      {id:'fin', cat:'Finances', name:'Point finances (2 min)', xp:40},
      {id:'family', cat:'Famille', name:'Moment 1:1 (10 min)', xp:70},
      {id:'breath', cat:'Mental', name:'Respiration (2 min)', xp:40},
    ],
    doneByDay:{}
  }
};

function deepMerge(a,b){
  if(Array.isArray(a)) return (b ?? a);
  if(a && typeof a === 'object'){
    const out={...a};
    for(const k of Object.keys(b||{})) out[k]=deepMerge(a[k], b[k]);
    return out;
  }
  return (b ?? a);
}

let state = load();
state = state ? deepMerge(DEFAULTS, state) : JSON.parse(JSON.stringify(DEFAULTS));
save();

function addXp(amount){
  const day=todayKey();
  state.xp.byDay[day]=(state.xp.byDay[day]||0)+amount;
  state.xp.total=(state.xp.total||0)+amount;

  const last=state.meta.lastXpDay;
  if(!last){ state.meta.streak=1; state.meta.lastXpDay=day; }
  else if(last===day){}
  else{
    const d1=new Date(last+'T00:00:00'), d2=new Date(day+'T00:00:00');
    const diff=Math.round((d2-d1)/86400000);
    state.meta.streak = (diff===1) ? (state.meta.streak||0)+1 : 1;
    state.meta.lastXpDay=day;
  }
  save();
}

const TABS = [
  {id:'hud', label:'HUD'},
  {id:'q', label:'Quêtes'},
  {id:'s', label:'Sport'},
  {id:'p', label:'Plus'},
];

let tab = 'hud';

function renderTabs(){
  const el=$("#tabs");
  el.innerHTML = TABS.map(t => `
    <div class="tab ${t.id===tab?'active':''}" data-tab="${t.id}">${t.label}</div>
  `).join('');
  el.querySelectorAll('.tab').forEach(x => x.addEventListener('click', () => {
    tab = x.dataset.tab;
    $("#topPill").textContent = "STATION " + tab.toUpperCase();
    render();
  }));
  $("#topPill").textContent = "STATION " + tab.toUpperCase();
}

function card(title, rightHtml, bodyHtml){
  return `
    <div class="card">
      <div class="row between">
        <div class="mono" style="letter-spacing:.14em;text-transform:uppercase;font-weight:900;color:var(--hud)">${title}</div>
        ${rightHtml||''}
      </div>
      <div class="hr"></div>
      ${bodyHtml||''}
    </div>
  `;
}
function progress(value, max){
  const pct = max<=0?0: Math.max(0, Math.min(100, (value/max)*100));
  return `<div class="progress"><div style="width:${pct}%"></div></div>`;
}

function screenHud(){
  const day=todayKey();
  const xpToday=state.xp.byDay[day]||0;
  const level=Math.floor(xpToday/500)+1;
  const into=xpToday%500;
  const rank = level>=6?'ODST VETERAN':level>=3?'FIELD READY':'RECRUIT';

  const fin = state.finance.bars.map(b=>{
    const isDebt=b.target===0;
    const label=isDebt?`Restant: <span class="mono">${b.current}€</span>`:`<span class="mono">${b.current}€</span> / <span class="mono">${b.target}€</span>`;
    return `
      <div>
        <div class="row between"><div style="font-weight:800">${b.name}</div><small>${label}</small></div>
        ${isDebt?'':`<div style="margin-top:8px">${progress(b.current, b.target||1)}</div>`}
      </div>
    `;
  }).join('');

  return `
    <div class="grid">
      ${card("Statut du jour", `<div class="pill">STREAK ${state.meta.streak||0}</div>`, `
        <div class="row" style="gap:14px">
          <div class="kpi" style="flex:1">
            <div class="value">${xpToday}</div>
            <div class="label">XP aujourd’hui</div>
          </div>
          <div class="kpi" style="flex:1">
            <div class="value">Lv ${level}</div>
            <div class="label">Niveau du jour</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="row between"><small>Progression (500 XP)</small><small class="mono">${into}/500</small></div>
          <div style="margin-top:8px">${progress(into, 500)}</div>
        </div>
        <div class="hr"></div>
        <div class="row between">
          <div class="badge"><div class="mono" style="font-weight:900;color:var(--hud2)">RANG</div><div style="font-weight:900">${rank}</div></div>
          <div class="badge"><div class="mono" style="font-weight:900;color:var(--hud2)">TOTAL</div><div style="font-weight:900">${state.xp.total||0} XP</div></div>
        </div>
      `)}
      ${card("Finances — aperçu", "", `<div class="grid">${fin}<small class="hint">Modifie les valeurs dans “Plus → Finances”.</small></div>`)}
    </div>
  `;
}

function screenQuests(){
  const day=todayKey();
  const done=state.quests.doneByDay[day]||{};
  const items=state.quests.items;
  const total=items.length;
  const completed=Object.keys(done).length;
  const pct= total? Math.round(completed/total*100):0;

  const cats=[...new Set(items.map(q=>q.cat))];

  const blocks=cats.map(cat=>{
    const qs=items.filter(q=>q.cat===cat);
    const inner=qs.map(q=>{
      const checked=!!done[q.id];
      return `
        <label style="display:flex;gap:10px;align-items:center;margin:0;cursor:pointer">
          <input type="checkbox" data-q="${q.id}" ${checked?'checked':''} style="width:18px;height:18px"/>
          <div style="flex:1">
            <div style="font-weight:800">${q.name}</div>
            <small class="mono">+${q.xp} XP</small>
          </div>
        </label>
      `;
    }).join('');
    return `
      <div class="box">
        <div class="mono" style="font-weight:900;color:var(--hud2)">${cat}</div>
        <div style="margin-top:10px" class="grid">${inner}</div>
      </div>
    `;
  }).join('');

  return `
    <div class="grid">
      ${card("Quêtes — checklist", `<div class="pill">${pct}%</div>`, `
        <div class="row between"><small>Complétées aujourd’hui</small><small class="mono">${completed}/${total}</small></div>
        <div class="hr"></div>
        <div class="grid">${blocks}</div>
        <div class="hr"></div>
        <small class="hint">Cocher = gagne l’XP. Décoche = ne retire pas l’XP (simple & motivant).</small>
      `)}
    </div>
  `;
}
// -------------------- SPORT --------------------
if(!state.sport){
  state.sport = {
    logsByDay:{},
    autoFillMax:true
  };
  save();
}

const WORKOUTS = {
  A: {
    name: "Séance A",
    xp: 250,
    restSec: 75,
    exercises: [
      { id:"latpulldown", name:"Tirage vertical (poulie haute)", sets:3, type:"reps", target:10 },
      { id:"chestpress", name:"Chest press", sets:3, type:"reps", target:10 },
      { id:"goblet", name:"Goblet squat", sets:3, type:"reps", target:12 },
      { id:"lowrow", name:"Rowing poulie basse", sets:3, type:"reps", target:10 },
      { id:"plank", name:"Gainage", sets:2, type:"sec", target:45 },
    ]
  },
  B: {
    name: "Séance B",
    xp: 250,
    restSec: 75,
    exercises: [
      { id:"pullups", name:"Tractions (ou négatives)", sets:3, type:"reps", target:5 },
      { id:"pecdeck", name:"Pec deck", sets:3, type:"reps", target:12 },
      { id:"legcurl", name:"Leg curl", sets:3, type:"reps", target:12 },
      { id:"pushups", name:"Pompes sur poignées", sets:3, type:"reps", target:10 },
      { id:"kneeraises", name:"Relevés de genoux", sets:2, type:"reps", target:10 },
    ]
  },
  MINI: {
    name: "Séance MINI (12 min)",
    xp: 150,
    restSec: 20,
    exercises: [
      { id:"mini1", name:"Circuit 1 — Squats + Pompes", sets:2, type:"sec", target:360 },
      { id:"mini2", name:"Circuit 2 — Rowing + Gainage", sets:2, type:"sec", target:360 },
    ]
  }
};

let session = null; // session active

function makeSession(code){
  const w = WORKOUTS[code];
  const flat = [];
  w.exercises.forEach(ex=>{
    for(let i=1;i<=ex.sets;i++){
      flat.push({ exId:ex.id, exName:ex.name, setIndex:i, type:ex.type, target:ex.target, value:null });
    }
  });
  return {
    code,
    startedAt: Date.now(),
    phase: "work", // work | rest | done
    restLeftMs: 0,
    i: 0,
    flat,
    totalSets: flat.length,
    timer: null
  };
}

function currentSet(){
  if(!session) return null;
  return session.flat[session.i] || null;
}

function startRest(){
  const w=WORKOUTS[session.code];
  session.phase="rest";
  session.restLeftMs = (w.restSec||60)*1000;
  vibrate(250); beep();
}

function finishSet(){
  const s=currentSet();
  if(!s) return;
  // auto fill max
  if((s.value===null || s.value==="") && state.sport.autoFillMax){
    s.value = s.target;
  }
  session.i++;
  if(session.i>=session.flat.length){
    session.phase="done";
    return;
  }
  startRest();
}

function tick(){
  if(!session) return;
  if(session.phase==="rest"){
    session.restLeftMs -= 250;
    if(session.restLeftMs<=0){
      session.phase="work";
      session.restLeftMs=0;
      vibrate(120); beep();
    }
  }
  render();
}

function stopTimer(){
  if(session && session.timer){
    clearInterval(session.timer);
    session.timer=null;
  }
}

function startTimer(){
  stopTimer();
  session.timer = setInterval(tick, 250);
}

function saveWorkoutLog(){
  const day=todayKey();
  const w=WORKOUTS[session.code];
  const durationMs = Date.now()-session.startedAt;

  const setsDone = session.flat.filter(x=>x.value!==null && x.value!=="" ).length;
  const log = {
    code: session.code,
    name: w.name,
    date: day,
    startedAt: session.startedAt,
    durationMs,
    totalSets: session.totalSets,
    setsDone,
    flat: session.flat,
    xp: w.xp
  };

  state.sport.logsByDay[day] = state.sport.logsByDay[day] || [];
  state.sport.logsByDay[day].push(log);
  save();

  // quest "sport" auto-check
  state.quests.doneByDay[day]=state.quests.doneByDay[day]||{};
  if(!state.quests.doneByDay[day]["sport"]){
    state.quests.doneByDay[day]["sport"]=true;
    addXp(w.xp);
  }else{
    addXp(w.xp); // on donne l'XP quand même
  }
  save();
}

function screenSport(){
  const day=todayKey();
  const logs = state.sport.logsByDay[day] || [];
  const logsHtml = logs.length ? logs.slice().reverse().map(l=>`
    <div class="box">
      <div class="row between">
        <div style="font-weight:900">${l.name}</div>
        <small class="mono">${msToClock(l.durationMs)}</small>
      </div>
      <small class="hint">Sets: ${l.setsDone}/${l.totalSets} · XP +${l.xp}</small>
    </div>
  `).join('') : `<small class="hint">Aucun log aujourd’hui.</small>`;

  if(session){
    const set = currentSet();
    const w=WORKOUTS[session.code];
    const pct = Math.round((session.i/session.totalSets)*100);

    const title = session.phase==="done" ? "Mission terminée" : (session.phase==="rest" ? "Repos" : "Série");
    const right = `<div class="pill">${pct}%</div>`;

    let body = "";
    if(session.phase==="done"){
      body = `
        <div class="badge"><div class="mono" style="font-weight:900;color:var(--hud2)">XP</div><div style="font-weight:900">+${w.xp}</div></div>
        <div class="hr"></div>
        <button class="btn primary" id="saveWorkout">Sauvegarder le log</button>
        <button class="btn ghost" id="cancelWorkout" style="margin-left:8px">Annuler</button>
      `;
    }else if(session.phase==="rest"){
      body = `
        <div class="kpi">
          <div class="value mono">${msToClock(session.restLeftMs)}</div>
          <div class="label">Repos</div>
        </div>
        <div class="hr"></div>
        <button class="btn" id="skipRest">Passer le repos</button>
      `;
    }else{
      const placeholder = set.type==="reps" ? "reps" : "secondes";
      body = `
        <div class="mono" style="font-weight:900;letter-spacing:.08em;color:var(--hud2)">${w.name}</div>
        <div style="margin-top:10px;font-weight:900">${set.exName}</div>
        <small class="hint">Série ${set.setIndex} / ${w.exercises.find(e=>e.id===set.exId)?.sets || "?"} · cible ${set.target} ${placeholder}</small>
        <label>Valeur (optionnel)</label>
        <input inputmode="numeric" id="setValue" placeholder="${set.target}">
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn primary" id="finishSet">Terminer la série</button>
          <button class="btn ghost" id="endWorkout">Stop</button>
        </div>
        <small class="hint">Si tu ne remplis pas, l’app met automatiquement la valeur MAX cible.</small>
      `;
    }

    return `
      <div class="grid">
        ${card("Sport — session active", right, body)}
        ${card("Logs du jour", "", `<div class="grid">${logsHtml}</div>`)}
      </div>
    `;
  }

  const pick = `
    <div class="grid">
      ${Object.keys(WORKOUTS).map(code=>{
        const w=WORKOUTS[code];
        return `
          <div class="box">
            <div class="row between">
              <div style="font-weight:900">${w.name}</div>
              <small class="mono">+${w.xp} XP</small>
            </div>
            <small class="hint">${w.exercises.length} exercices · repos ${w.restSec}s</small>
            <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap">
              <button class="btn primary" data-start="${code}">Démarrer</button>
            </div>
          </div>
        `;
      }).join('')}
      <div class="box">
        <div class="row between">
          <div style="font-weight:900">Option</div>
          <small class="mono">AUTO</small>
        </div>
        <label><input type="checkbox" id="autoFill" ${state.sport.autoFillMax?'checked':''} style="width:18px;height:18px"> Auto-remplir MAX</label>
        <small class="hint">Si tu oublies de saisir, l’app met la cible automatiquement.</small>
      </div>
    </div>
  `;

  return `
    <div class="grid">
      ${card("Sport — Séances", "", pick)}
      ${card("Logs du jour", "", `<div class="grid">${logsHtml}</div>`)}
    </div>
  `;
      }
  
function screenPlus(){
  const fin = state.finance.bars.map(b=>`
    <div class="box">
      <div class="row between"><div style="font-weight:900">${b.name}</div><small class="mono">${b.target===0?'RESTANT':'CIBLE'}</small></div>
      ${b.target===0?'':`<div style="margin-top:8px">${progress(b.current, b.target||1)}</div>`}
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Valeur</label>
          <input inputmode="numeric" data-fin-cur="${b.id}" value="${b.current}">
        </div>
        <div style="flex:1">
          <label>Cible</label>
          <input inputmode="numeric" data-fin-tgt="${b.id}" value="${b.target}">
        </div>
      </div>
      <small class="hint">Pour une dette : mets cible = 0 (affiche “restant”).</small>
    </div>
  `).join('');

  return `
    <div class="grid">
      ${card("Finances — éditer barres", "", `<div class="grid">${fin}</div>`)}
      ${card("Données — export / import / reset", "", `
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="doExport">Exporter JSON</button>
          <button class="btn" id="doImport">Importer JSON</button>
          <button class="btn danger" id="doReset">RESET</button>
        </div>
        <label>JSON</label>
        <textarea id="jsonArea" placeholder="Exporter → copie. Importer → colle ici."></textarea>
        <small class="hint">Tout est offline (localStorage). Export/import = sauvegarde manuelle.</small>
      `)}
    </div>
  `;
}

function bind(){
  document.querySelectorAll('[data-q]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const qid = cb.dataset.q;
      const day=todayKey();
      state.quests.doneByDay[day]=state.quests.doneByDay[day]||{};
      const was = !!state.quests.doneByDay[day][qid];

      if(cb.checked) state.quests.doneByDay[day][qid]=true;
      else delete state.quests.doneByDay[day][qid];

      if(!was && cb.checked){
        const q = state.quests.items.find(x=>x.id===qid);
        if(q) addXp(q.xp);
      }else save();

      render();
    });
  });

  document.querySelectorAll('[data-fin-cur]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const id=inp.dataset.finCur;
      const b=state.finance.bars.find(x=>x.id===id);
      if(b) b.current = Number(inp.value||0);
      save();
    });
  });
  document.querySelectorAll('[data-fin-tgt]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const id=inp.dataset.finTgt;
      const b=state.finance.bars.find(x=>x.id===id);
      if(b) b.target = Number(inp.value||0);
      save();
    });
  });

  const doExport=$("#doExport");
  if(doExport) doExport.addEventListener('click', ()=>{
    $("#jsonArea").value = JSON.stringify(state, null, 2);
  });
  const doImport=$("#doImport");
  if(doImport) doImport.addEventListener('click', ()=>{
    try{
      const parsed = JSON.parse($("#jsonArea").value);
      state = deepMerge(DEFAULTS, parsed);
      save();
      render();
      alert("Import OK");
    }catch{
      alert("JSON invalide");
    }
  });
  const doReset=$("#doReset");
  if(doReset) doReset.addEventListener('click', ()=>{
    if(confirm("RESET complet ?")){
      state = JSON.parse(JSON.stringify(DEFAULTS));
      save();
      render();
    }
  });
  // --- SPORT binds ---
  document.querySelectorAll('[data-start]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const code=btn.dataset.start;
      session = makeSession(code);
      startTimer();
      render();
    });
  });

  const auto=$("#autoFill");
  if(auto) auto.addEventListener('change', ()=>{
    state.sport.autoFillMax = !!auto.checked;
    save();
  });

  const finish=$("#finishSet");
  if(finish) finish.addEventListener('click', ()=>{
    const set=currentSet();
    const v = $("#setValue") ? $("#setValue").value : "";
    if(set){
      set.value = (v===""? null : Number(v));
    }
    finishSet();
    save();
    render();
  });

  const skip=$("#skipRest");
  if(skip) skip.addEventListener('click', ()=>{
    session.phase="work";
    session.restLeftMs=0;
    vibrate(120); beep();
    render();
  });

  const end=$("#endWorkout");
  if(end) end.addEventListener('click', ()=>{
    if(confirm("Stopper la séance ?")){
      stopTimer();
      session=null;
      render();
    }
  });

  const saveW=$("#saveWorkout");
  if(saveW) saveW.addEventListener('click', ()=>{
    saveWorkoutLog();
    stopTimer();
    session=null;
    render();
    alert("Workout log sauvegardé + XP ajouté.");
  });

  const cancelW=$("#cancelWorkout");
  if(cancelW) cancelW.addEventListener('click', ()=>{
    stopTimer();
    session=null;
    render();
  });
}

function render(){
  const app=$("#app");
  if(tab==='hud') app.innerHTML = screenHud();
  if(tab==='q') app.innerHTML = screenQuests();
  if(tab==='s') app.innerHTML = screenSport();
  if(tab==='p') app.innerHTML = screenPlus();
  bind();
}

renderTabs();
render();
</script>
</body>
</html>
